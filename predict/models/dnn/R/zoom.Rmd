---
title: "Zoom"
author: "Christof Angermueller"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
---

```{r, include=F}
library(knitr)
opts_chunk$set(echo=F, warning=F, message=F, fig.width=12)
```

```{r, include=F}
library(ggplot2)
library(tidyr)
library(rhdf5)
library(grid)
library(gridExtra)
library(scales)
library(tools)
library(biomaRt)
library(Gviz)
library(dplyr)

lib <- file.path(Sys.getenv('Pd'), 'R')
source(file.path(lib, 'utils.R'))
source(file.path(lib, 'zoom.R'))
source(file.path(lib, 'zoom_io.R'))
```

```{r}
opts <- list()
opts$pred_file <- './pred.h5'
opts$filt_act_file <- './filter_act.h5'
opts$filt_imp_file <- './filter_imp.h5'
opts$seqmut_file <- './seqmut.h5'
opts$seqmut <- 'rnd'
opts$seqmut_wlen <- 10
opts$filt_excl <- NULL
opts$cache <- T
opts$annos_root <- file.path(Sys.getenv('Pannos'), 'misc')
opts$annos <- c('CGI.bed', 'LMRs.bed', 'p300.bed', 'H3K4me1.bed',
  'H3K27ac.bed', 'H3K27me3.bed', 'Active_enhancers.bed')
opts$tracks_height <- 10
opts_chunk$set(fig.width=12, fig.height=22)
dat <- list()
```

```{r cache=opts$cache}
dat$pred <- read_h5(opts$pred_file)
dat$seqmut <- read_h5(opts$seqmut_file) %>% format_seqmut
dat$filt_imp <- read_h5(opts$filt_imp_file) %>% format_filt_imp
dat$filt_act <- read_filt_act(opts$filt_act_file, wlen=101)
```

```{r}
dat$seqmut <- read_h5(opts$seqmut_file) %>% format_seqmut
```

```{r cache=opts$cache}
bed <- list()
for (fname in opts$annos) {
  n <- file_path_sans_ext(fname)
  h <- file.path(opts$annos_root, fname)
  bed[[n]] <- read_bed(h)
}

bed$SE <- data.frame(
  chromo='chr12',
  start=c(86466096, 86498435),
  end=c(86479369, 86505242)
  )
dat$bed <- bed
```

# Esrrb

```{r}
region <- data.frame(name='gene', genome='mm10', chromo='chr12',
  start=86361100, end=86521700)
```

```{r fig.height=opts$tracks_height}
tracks <- get_tracks(region)
plot_tracks(tracks, region)
```

```{r}
p <- get_plots(region)
plot_grid(p)
```


# Superenhancer 1

```{r}
region <- data.frame(name='SE1', genome='mm10', chromo='chr12',
  start=86465000, end=86480000)
```

```{r fig.height=opts$tracks_height}
tracks <- get_tracks(region)
plot_tracks(tracks, region)
```

```{r}
p <- get_plots(region)
plot_grid(p)
```

```{r eval=F}
d <- dat$seqmut %>% data_seqmut(
  region=region, seqmut=opts$seqmut, wlen=opts$seqmut_wlen)
plot_seqmut(d, what='del', span=0.05)
```
