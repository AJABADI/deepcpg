---
title: "Evaluation"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
---

```{r, include=F}
library(knitr)
opts_chunk$set(echo=F, warning=F, message=F)
```

```{r, include=F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(RSQLite)
library(xtable)
library(grid)
library(rhdf5)

lib <- file.path(Sys.getenv('Pd'), 'R')
source(file.path(lib, 'utils.R'))
# source(file.path(lib, 'eval_var_dist.R'))
```

```{r}
options(xtable.type='html')
```

```{r}
dat <- list()
cmp <- list()
opts <- list()
opts$pred_file <- './test_sliced.h5'
opts$annos <- '^loc_.*'
opts$wlen <- 3000
```

```{r}
read_group <- function(path, group) {
  d <- list()
  for (k in c('y', 'z')) {
    d[[k]] <- h5read(path, sprintf('%s/%s', group, k))
  }
  d <- as.data.frame(d) %>% tbl_df %>% mutate(name=basename(group))
  return (d)
}

read_pred <- function(path, target, annos_regex=NULL) {
  d <- list()
  d[[length(d) + 1]] <- read_group(path, sprintf('/%s/global', target))
  annos <- h5ls(path, sprintf('/%s/annos', target))
  if (!is.null(annos_regex)) {
    annos <- grep(annos_regex, annos, value=T)
  }
  for (anno in annos) {
    d[[length(d) + 1]] <- read_group(path, sprintf('/%s/annos/%s', target, anno))
  }
  d <- do.call(rbind.data.frame, d) %>%
    mutate(name=factor(name)) %>% tbl_df
  return (d)
}

plot_dist_match <- function(d, metric_='mean') {
  d <- d %>% filter(metric == metric_)
  d <- d %>% gather(key, value, y, z)
  p <- ggplot(d, aes(x=anno, y=value)) +
    geom_boxplot(aes(fill=key)) +
    scale_fill_manual(values=colors_$yz) +
    theme_pub() +
    theme(
      legend.position='top'
    ) +
    xlab('') + ylab(metric) +
    facet_wrap(~cell_type, ncol=1) +
    theme(axis.text.x=element_text(angle=30, hjust=1))
  return (p)
}

plot_dist_type <- function(d, metric_='mean') {
  d <- d %>% filter(metric == metric_)
  d <- d %>% gather(key, value, z, y)
  p <- ggplot(d, aes(x=anno, y=value)) +
    geom_boxplot(aes(fill=cell_type)) +
    scale_fill_manual(values=colors_$cell_type) +
    theme_pub() +
    theme(
      axis.text.x=element_text(angle=30, hjust=1),
      legend.position='top'
    ) +
    xlab('') + ylab(metric) +
    facet_wrap(~key, ncol=1)
  return (p)
}
```

```{r}
d <- list()
for (metric in c('mean', 'var')) {
  for (cell_type in c('ser', '2i')) {
    h <- sprintf('%s_w%d_%s', cell_type, opts$wlen, metric)
    d[[length(d) + 1]] <- read_pred(opts$pred_file, h, annos=opts$annos) %>%
      mutate(metric=metric, cell_type=cell_type)
  }
}
dat$yz <- do.call(rbind.data.frame, d) %>%
  mutate(
    cell_type=factor(cell_type, levels=c('2i', 'ser'), labels=c('2i', 'serum')),
    metric=factor(metric)
    ) %>%
  rename(anno=name)
```

```{r}
fig.width <- length(levels(dat$yz$anno)) * 0.6
fig.height <- 8
```

## Predicted vs. true methylation
```{r fig.width=fig.width, fig.height=fig.height}
plot_dist_match(dat$yz, 'mean')
plot_dist_type(dat$yz, 'mean')
```

## Predicted vs. true variance
```{r fig.width=fig.width, fig.height=fig.height}
plot_dist_match(dat$yz, 'var')
plot_dist_type(dat$yz, 'var')
```
