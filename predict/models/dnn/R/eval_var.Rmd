---
title: "Evaluation"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
---

```{r, include=F}
library(knitr)
opts_chunk$set(echo=F, warning=F, message=F)
```

```{r, include=F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(RSQLite)
library(xtable)
library(grid)

lib <- file.path(Sys.getenv('Pd'), 'R')
source(file.path(lib, 'utils.R'))
# source(file.path(lib, 'eval_var.R'))
```

```{r}
options(xtable.type='html')
```

<style>
img {
    max-width: none;
}
</style>

```{r}
dat <- list()
cmp <- list()
opts <- list()
opts$db_file <- './test.sql'
opts$annos <- NULL
opts$wlen <- 3000


filter_data <- function(d) {
  if (!is.null(opts$wlen)) {
    d <- d %>% filter(wlen == opts$wlen)
  }
  return (d)
}
```

```{r}
format_target <- function(d) {
    d <- d %>%
      separate(target, c('cell_type', 'wlen', 'metric'), by='_', remove=F) %>%
      mutate(
        cell_type=factor(cell_type, levels=c('2i', 'ser'), labels=c('2i', 'serum')),
        wlen=as.integer(sub('w', '', wlen))
      )
    return (d)
}

query_db <- function(db_file, table, models=NULL) {
  con <- src_sqlite(db_file)
  d <- tbl(con, sql(sprintf('SELECT * FROM %s', table)))
  d <- d %>% collect
  if (!is.null(models)) {
    d <- d %>% filter(model %in% models)
  }
  d <- d %>% select(-c(path, id)) %>%
    gather(fun, value, 1:9)
  d <- d %>% format_target
  d <- d %>% char_to_factor %>% droplevels %>% tbl_df %>%
    move_cols(c('model', 'target', 'cell_type', 'wlen'))
  return (d)
}

stats <- function(d, metric_='var') {
  s <- d %>% filter(metric==metric_) %>%
    group_by(anno, fun) %>% summarise(value=mean(value)) %>% ungroup %>%
    spread(fun, value) %>%
    arrange(desc(mse))
  return (s)
}

plot_annos <- function(d, fun_='mse') {
  d <- d %>% filter(fun == fun_) %>% droplevels
  p <- ggplot(d, aes(x=anno, y=value)) +
    geom_bar(aes(fill=cell_type), stat='identity', position='dodge') +
    scale_fill_manual(values=colors_$cell_type) +
    facet_wrap(~metric, ncol=1, scale='free') +
    theme_pub() +
    theme(
      axis.text.x=element_text(angle=30, hjust=1),
      legend.position='top'
    ) +
    xlab('') + ylab(fun_)
  return (p)
}

plot_annos_funs <- function(d, funs=c('mse', 'rmse', 'mad', 'cor')) {
  for (fun in funs) {
    p <- plot_annos(d, fun=fun)
    print(p)
  }
}

plot_yz <- function(d, metric_='mean', median=F) {
  d <- d %>% filter(metric == metric_)
  if (median) {
    funs <- c('y'='ymed', 'z'='zmed')
  } else {
    funs <- c('y'='y', 'z'='z')
  }
  d <- d %>% filter(fun %in% funs) %>%
    mutate(fun=factor(fun, levels=funs, labels=names(funs)))
  p <- ggplot(d, aes(x=anno, y=value)) +
    geom_bar(aes(fill=fun), stat='identity', position='dodge') +
    scale_fill_manual(values=colors_$yz) +
    theme_pub() +
    theme(
      axis.text.x=element_text(angle=30, hjust=1),
      legend.position='top'
    ) +
    xlab('') + ylab(metric_) +
    facet_wrap(~cell_type, ncol=1, scale='free')
  return (p)
}
```

```{r include=F}
dat$global <- query_db(opts$db_file, 'global') %>% filter_data
dat$annos <- query_db(opts$db_file, 'annos') %>% filter_data
d <- dat$global %>% mutate(anno='global')
dat$all <- rbind.data.frame(d, dat$annos) %>%
  mutate(anno=factor(anno)) %>%
  move_cols(c('model', 'anno'))
```

```{r}
cmp$sv <- stats(dat$all, 'var')
cmp$sm <- stats(dat$all, 'mean')
cmp$order <- as.vector(cmp$sv$anno)
dat$all <- dat$all %>% mutate(anno=factor(anno, levels=cmp$order))
```

```{r}
fig.width <- length(levels(dat$all$anno)) * 0.4
fig.height <- 8
```

## Predicted vs. true methylation rate
```{r fig.width=fig.width, fig.height=fig.height}
plot_yz(dat$all, 'mean', F)
```

## Predicted vs. true variance
```{r fig.width=fig.width, fig.height=fig.height}
plot_yz(dat$all, 'var', F)
```

## Metrices

```{r fig.width=fig.width, fig.height=fig.height}
plot_annos_funs(dat$all)
```
