---
title: Filter motifs
author: "Christof Angermueller"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
---

```{r, include=F}
library(knitr)
opts_chunk$set(echo=F, warning=F, message=F)
```

```{r, include=F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(grid)
library(gridExtra)
library(scales)
library(xtable)
library(gplots)
library(RColorBrewer)
library(seqLogo)
library(rhdf5)

lib <- file.path(Sys.getenv('Pd'), 'R')
source(file.path(lib, 'utils.R'))
source(file.path(lib, 'filter.R'))
lib <- file.path(Sys.getenv('Pv'), 'R')
source(file.path(lib, 'utils.R'))
source(file.path(lib, 'filter_motifs.R'))
```

```{r}
options(xtable.type='html')
```

<style>
img {
    max-width: none;
}
</style>

```{r}
opts <- list()
opts$weights_file <- './filter_weights.h5'
opts$weights_path <- '/s_c1/weights'
opts$act_file <- './filter_act.sql'
opts$tomtom_file <- './tomtom/tomtom.csv'
if (exists('args')) {
  for (n in names(args)) {
    opts[[n]] <- args[[n]]
  }
}

dat <- list()
```

```{r}
dat$filt <- read_filt(opts$weights_file, group=opts$weights_path)
dat$motifs <- dat$filt %>% group_by(filt) %>%
  summarise(motif=filt_motif(dat$filt, filt)) %>%
  mutate(
    motif=factor(motif),
    label=factor(paste(as.vector(filt), as.vector(motif), sep=': '))
  )
dat$tab <- dat$motifs %>% select(-motif)
```

```{r eval=!(is.null(opts$act_file))}
dat$act <- query_db(opts$act_file)
h <- dat$act %>% select(-c(target, n)) %>%
  filter(act_mean != 0) %>%
  mutate(filt=factor(filt)) %>%
  group_by(filt) %>% summarise_each(funs(mean(., na.rm=T)))
dat$tab <- dat$tab %>% inner_join(h) %>% arrange(desc(abs(rs)))
```

```{r eval=!is.null(opts$tomtom_file)}
dat$tomtom_all <- read_tomtom(opts$tomtom_file, all=T)
dat$tomtom <- read_tomtom(opts$tomtom_file) %>% select(-nb_hits)
dat$tab <- dat$tab %>% left_join(dat$tomtom)
```

```{r results='asis'}
d <- dat$tab %>% select(-filt)
print(xtable(d, digits=4, include.rownames=F))
```

```{r motifs, results='asis'}
for (f in dat$tab$filt) {
  cat('<br><br><hr>', fill=T)
  d <- filt_pwm(dat$filt, f)
  seqLogo(d)
  h <- dat$tab %>% filter(filt == f)
  print(xtable(h))
  cat('<br>', fill=T)
  if (!is.null(dat$tomtom)) {
    h <- dat$tomtom_all %>% filter(filt == f) %>%
      select(-c(filt, Orientation, Query.ID, Optimal.offset))
    print(xtable(h, digits=2))
  }
}
```
