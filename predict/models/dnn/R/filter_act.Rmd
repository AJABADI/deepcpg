---
title: Filter activation
author: "Christof Angermueller"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
---

```{r, include=F}
library(knitr)
opts_chunk$set(echo=F, warning=F, message=F)
```

```{r, include=F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(grid)
library(gridExtra)
library(scales)
library(xtable)
library(gplots)
library(RColorBrewer)
library(seqLogo)
library(rhdf5)

lib <- file.path(Sys.getenv('Pd'), 'R')
source(file.path(lib, 'utils.R'))
source(file.path(lib, 'filter_act.R'))
```

```{r}
options(xtable.type='html')
```

```{r}
opts <- list()
opts$db_file <- './eval_filter_act.sql'
opts$nb_sel <- 25
opts$annos <- "loc%"
dat <- list()

filter_data <- function(d) {
  d <- d #%>% filter(filt != '8')
  return (d)
}
```

# Global

```{r fig.width=10, height=5}
dat$global <- query_db(opts$db_file) %>% filter_data
```

```{r}
act_mean <- dat$global %>% group_by(filt) %>% summarise(act_mean=mean(act_mean)) %>%
  arrange(desc(act_mean)) %>%
  mutate(filt=factor(filt, levels=unique(filt)))
```

```{r}
```{r fig.width=10, height=5}
d <- act_mean %>% head(opts$nb_sel)
ggplot(d, aes(x=filt, y=act_mean)) +
  geom_bar(stat='identity') +
  xlab('Filter') + ylab('Mean activation') +
  theme_pub()
```

```{r}
filts <- dat$global %>% group_by(filt) %>% summarise(r=mean(abs(r))) %>%
  arrange(desc(r)) %>% head(opts$nb_sel) %>% select(filt) %>% unlist
```

```{r fig.width=10, height=5}
d <- dat$global %>% filter(filt %in% filts) %>%
  mutate(filt=factor(filt, levels=filts))
plot_global(d)
```

```{r fig.width=12, fig.height=15}
p <- plot_heat(dat$global)
```

```{r fig.width=12, fig.height=15}
p <- plot_heat(dat$global, del=T)
```

# Annotations

```{r}
dat$annos <- query_db(opts$db_file, 'annos')
```


## Overview

```{r results='asis'}
astats <- dat$annos %>% group_by(anno) %>%
  summarise(n=mean(n), r=mean(abs(r))) %>%
  arrange(desc(r)) %>%
  mutate(anno=factor(anno, levels=anno))
xtable(astats)
```

```{r fig.width=10}
d <- dat$anno %>% mutate(anno=factor(anno, levels=astats$anno))
plot_annos_mean(d)
```

## Heatmaps

```{r fig.width=10, fig.height=15}
p <- plot_annos_heat(dat$annos)
```

```{r fig.width=10, fig.height=15}
p <- plot_annos_heat(dat$annos, del=T)
```

## Top filters by global order

```{r fig.width=10, fig.height=length(levels(dat$annos$anno)) * 4}
d <- dat$annos %>% filter(filt %in% filts) %>% droplevels %>%
  mutate(filt=factor(filt, levels=filts),
    anno=factor(anno, levels=astats$anno))
plot_annos(d)
```

## Top filters by anno

```{r fig.width=10, fig.height=4}
for (anno_ in astats$anno) {
  d <- dat$annos %>% filter(anno == anno_) %>% droplevels
  f <- d %>% group_by(filt) %>% summarise(r=mean(abs(r))) %>%
    arrange(desc(r)) %>% head(opts$nb_sel) %>% select(filt) %>% unlist
  d <- d %>% filter(filt %in% f) %>% droplevels %>%
    mutate(filt=factor(filt, levels=f))
  print(plot_annos(d))
}
```

# Statistics

```{r}
dat$stats <- query_db(opts$db_file, 'stats') %>% format_stats
```

```{r fig.width=10, fig.height=20}
plot_stats(dat$stats)
```

## CG content
```{r fig.width=10, fig.height=20}
plot_stat(dat$stats, 'gc_content')
```

## CG obs / exp
```{r fig.width=10, fig.height=20}
plot_stat(dat$stats, 'cg_obs_exp')
```

## Variability (win)
```{r fig.width=10, fig.height=20}
plot_stat(dat$stats, 'var (win)')
```

## dist (win)
```{r fig.width=10, fig.height=20}
plot_stat(dat$stats, 'dist (win)')
```




